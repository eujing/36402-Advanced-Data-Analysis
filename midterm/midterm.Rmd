---
title: "36-402 Midterm"
author:
- Eu Jing Chua
- eujingc
date: "January 20, 2019"
output:
  pdf_document: default
header-includes:
    - \usepackage{enumerate}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

\newcommand{\est}[1]{\hat{#1}}
\newcommand{\betah}[1]{\est{\beta_{#1}}}
\newcommand{\avg}[1]{\overline{#1}}
\newcommand{\E}[1]{\mathbb{E} \left[ #1 \right]}
\newcommand{\Var}[1]{\text{Var} \left[ #1 \right]}
\newcommand{\Cov}[1]{\text{Cov} \left[ #1 \right]}
\newcommand{\X}{\mathbb{X}}
\newcommand{\sumTo}[1]{\sum^{#1}_{i=1}}
\newcommand{\sumjTo}[1]{\sum^{#1}_{j=1}}
\newcommand{\matr}[1]{\mathbf{#1}}

```{r}
library(knitr)
library(mgcv)
```

```{r}
# From page 144 of textbook
resample <- function(x) {
    sample(x, size = length(x), replace = TRUE)
}
# Taken from page 136 of textbook
rboot <- function(statistic, simulator, B) {
    tboots <- replicate(B, statistic(simulator()))
    if (is.null(dim(tboots))) {
        tboots <- array(tboots, dim = c(1, B))
    }
    return(tboots)
}

bootstrap <- function(tboots, summarizer, ...) {
    summaries <- apply(tboots, 1, summarizer, ...)
    return(t(summaries))
}

# From page 138 of textbook
equitails <- function(x, alpha) {
    lower <- quantile(x, alpha/2)
    upper <- quantile(x, 1 - alpha/2)
    return(c(lower, upper))
}
bootstrap.ci <- function(statistic = NULL, simulator = NULL, tboots = NULL,
    B = if (!is.null(tboots)) {
        ncol(tboots)
    }, t.hat, level) {

    if (is.null(tboots)) {
        stopifnot(!is.null(statistic))
        stopifnot(!is.null(simulator))
        stopifnot(!is.null(B))
        tboots <- rboot(statistic, simulator, B)
    }

    alpha <- 1 - level
    intervals <- bootstrap(tboots, summarizer = equitails, alpha = alpha)
    upper <- t.hat + (t.hat - intervals[, 1])
    lower <- t.hat + (t.hat - intervals[, 2])
    CIs <- cbind(lower = lower, upper = upper)
    return(CIs)
}
resample.data.frame <- function(data) {
    sample.rows <- resample(1:nrow(data))
    return(data[sample.rows, ])
}
```


```{r}
data <- read.csv("http://www.stat.cmu.edu/~cshalizi/uADA/19/exams/1/ch.csv")

# Remove data for ongoing civil wars
data <- data[!is.na(data$start), ]

```

# EDA

```{r fig.height = 8}
par(mfrow = c(4, 2))
hist(data$exports, xlab = "Exports")
hist(data$schooling, xlab = "Schooling")
hist(data$growth, xlab = "Growth")
hist(data$peace, xlab = "Peace")
hist(data$concentration, xlab = "Concentration")
hist(data$lnpop, xlab = "Log Population")
hist(data$fractionalization, xlab = "Fractionalization")
hist(data$dominance, xlab = "Dominance")
```

```{r fig.height = 8}
par(mfrow=c(4, 2))
boxplot(exports ~ data$start, data = data, xlab = "Start", ylab="Exports")
boxplot(schooling ~ data$start, data = data, xlab = "Start", ylab="Schooling")
boxplot(growth ~ data$start, data = data, xlab = "Start", ylab="Growth")
boxplot(peace ~ data$start, data = data, xlab = "Start", ylab="Peace")
boxplot(concentration ~ data$start, data = data, xlab = "Start", ylab="Concentration")
boxplot(lnpop ~ data$start, data = data, xlab = "Start", ylab="Log Population")
boxplot(fractionalization ~ data$start, data = data, xlab = "Start", ylab="Fractionalization")
boxplot(dominance ~ data$start, data = data, xlab = "Start", ylab="Dominance")
```

```{r}
resample.cases <- function() {
    resample.data.frame(data)
}
coef.estimator <- function(data) {
    new.lr.fit <- glm(factor(data$start) ~ exports + schooling + growth + peace + concentration + lnpop + fractionalization + dominance,
                      data = data, family="binomial")
    return(coef(new.lr.fit))
}
insamp.error <- function(model, y) {
    return(mean(ifelse(fitted(model) < 0.5, 0, 1) != y))
}
```

```{r}
glm.model.str <- factor(start) ~ exports + schooling + growth + peace + concentration + lnpop + fractionalization + factor(dominance)
gam.model.str <- factor(start) ~ s(exports) + s(schooling) + s(growth) + s(peace) + s(concentration) + s(lnpop) + s(fractionalization) + factor(dominance)
# glm.model.str <- factor(start) ~ exports + fractionalization + factor(dominance)
# gam.model.str <- factor(start) ~ s(exports) + s(fractionalization) + factor(dominance)
# glm.model.str <- factor(start) ~ exports + schooling + growth + peace + concentration + lnpop
# gam.model.str <- factor(start) ~ s(exports) + s(schooling) + s(growth) + s(peace) + s(concentration) + s(lnpop)

init.glm.fit <- glm(formula(glm.model.str),
                    data = data, family = "binomial")
init.gam.fit <- gam(formula(gam.model.str),
                    data = data, family = "binomial")
```

# Bootstrap 95% C.I for coefficients
```{r}
init.fit.coef.cis <- bootstrap.ci(statistic = coef.estimator,
                                  simulator = resample.cases,
                                  B = 100, t.hat = coef(init.fit),
                                  level = 0.95)
kable(init.fit.coef.cis)
```

# Model checking against GAM
```{r cache=TRUE}
# From page 250 of textbook
sim.glm <- function(data, model) {
    copied.data <- data.frame(data)
    probs <- predict(model, newdata = copied.data, type = "response")
    data$start <- rbinom(n = nrow(copied.data), size = 1, prob = probs)
    return(data)
}

sim.dev.diff <- function(data, model) {
    new.data <- sim.glm(data, model)
    new.glm.fit <- glm(formula(glm.model.str), data = new.data, family = "binomial")
    new.gam.fit <- gam(formula(gam.model.str), data = new.data, family = "binomial")
    return(new.glm.fit$dev - new.gam.fit$dev)
}

obs.dev.diff <- init.glm.fit$dev - init.gam.fit$dev
dev.diffs <- replicate(100, sim.dev.diff(na.omit(data), init.glm.fit))
```
```{r}
mean(obs.dev.diff <= dev.diffs)
```

# GAM partial-responses

```{r fig.height=8}
par(mfrow = c(4, 2))
plot(init.gam.fit)
```

# New model
```{r cache=TRUE}
glm.model.2.str <- "factor(start) ~ exports + concentration + lnpop"
gam.model.2.str <- "factor(start) ~ s(exports) + concentration + s(lnpop)"
clean.data <- subset(data, !is.na(exports) & !is.na(concentration) & !is.na(lnpop))
glm.fit.2 <- glm(formula(glm.model.2.str), data = clean.data, family = "binomial")
gam.fit.2 <- gam(formula(gam.model.2.str), data = clean.data, family = "binomial")
obs.dev.diff.2 <- glm.fit.2$dev - gam.fit.2$dev
dev.diffs.2 <- replicate(100, sim.dev.diff(clean.data, glm.fit.2))
```

```{r}
mean(obs.dev.diff.2 <= dev.diffs.2)
```
